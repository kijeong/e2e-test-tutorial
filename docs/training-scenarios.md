# 테스트 교육/실습 시나리오(깨짐 유도 → 안전한 확장)

이 문서는 **의도적으로 “새 기능 추가로 인한 로직 회귀(regression)”**를 만들고,
Unit/E2E 테스트가 깨지는 상황을 통해 **안전하게 수정/확장하는 경험**을 주기 위한 가이드입니다.

## Unit 시나리오: 가격/프로모션 엔진

대상 모듈:

- `src/domain/pricing/calculateOrderSummary.ts`
- 테스트: `src/domain/pricing/__tests__/calculateOrderSummary.test.ts`

### Stage 1: 현재(정상 동작)

- 쿠폰(정률/정액), 무료배송 임계값, 포인트 사용 한도 로직이 동작합니다.
- 특히 **무료배송 임계값은 할인 적용 후 금액 기준**입니다(테스트에 고정).

### Stage 2: 확장 기능 추가(의도)

#### 기능 A: “카테고리 한정 쿠폰” 확대

- 이미 `eligibleCategories`가 있으며 테스트도 추가되어 있습니다.
- 다음 확장 과제를 부여할 수 있습니다:
  - 카테고리가 없는 상품(`category: undefined`)은 **할인 대상에서 제외** 또는 **전체 대상** 중 하나로 정책 결정

#### 기능 B: “쿠폰/포인트 적용 순서” 옵션 추가

- 신규 요구사항: “포인트를 먼저 차감한 뒤 쿠폰을 적용한다”
- 구현 시 흔한 버그:
  - 기존 로직(쿠폰 → 포인트)을 유지한 채 UI만 바꿔서 결제 금액이 어긋남
  - 할인/포인트의 합이 결제 금액을 초과해 \(grandTotal < 0\) 발생

### Stage 3: 테스트 깨짐(버그 유도 예시)

다음 중 하나를 “새 기능 구현 중 실수”로 유도합니다(테스트를 바꾸는 게 아니라 **코드를 고쳐서** 통과시켜야 함).

- **무료배송 임계값 계산 버그**: 할인 전 금액(subtotal)로 무료배송을 판단해버림
  - 결과: `무료배송 임계값은 할인 적용 후 기준` 테스트가 깨짐
- **카테고리 필터 누락**: 한정 쿠폰이 모든 상품에 적용됨
  - 결과: `카테고리 한정 쿠폰` 테스트가 깨짐

## E2E 시나리오: 로그인 → 담기 → 구매

대상 테스트:

- `e2e/auth-and-purchase.spec.ts`

### Stage 1: 현재(기본 플로우)

- 로그인(데모 계정) → 상품(1번) 장바구니 담기 → 구매 플로우를 검증합니다.
- 안정적인 셀렉터: `data-testid` 사용
  - 로그인: `login-email`, `login-password`, `login-submit`
  - 네비: `nav-cart`
  - 담기: `add-to-cart-1`
  - 장바구니: `cart-item`
  - 결제: `checkout-button`

### Stage 2: UI 기능 추가(의도)

#### 기능 A: 선택 구매(checkbox)

- “선택된 상품만 결제” 기능을 추가합니다.
- 흔한 사이드 이펙트:
  - UI는 선택 상태를 보여주는데 `totalPrice`/주문 items 생성은 전체 기준으로 그대로라 결제 금액이 어긋남

#### 기능 B: 자동 쿠폰 적용 토글

- 토글 ON 시 자동으로 쿠폰을 적용해 결제 금액을 낮춤
- 흔한 사이드 이펙트:
  - 결제 버튼 disabled 조건이 잘못되어 결제가 막힘
  - 금액이 0 미만이 되어 주문 생성이 실패

### Stage 3: 테스트 깨짐(버그 유도 예시)

- “선택 구매” 구현 중 `checkout()`에서 주문 items를 선택 상태로 필터링하지 않아 잘못된 주문 생성
- “자동 쿠폰” 구현 중 할인 계산 오류로 결제가 실패(구매 플로우 E2E가 깨짐)

## 운영 팁

- E2E는 반복 실행을 위해 테스트에서 `cartItems`/`orders`를 정리합니다.
- 새 기능 추가 시 **Unit(로직) → E2E(사용자 플로우)** 순으로 회귀를 확인하는 흐름을 권장합니다.
